<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>İhale Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-img-top {
            transition: transform 0.3s ease;
        }
        .card:hover .card-img-top {
            transform: scale(1.05);
        }
        .countdown-box {
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
            letter-spacing: 1px;
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">İhale Paneli</a>
            <a href="/login" class="btn btn-outline-light btn-sm">Çıkış / Kayıt</a>
        </div>
    </nav>

    <div class="container">
        
        <h3 class="mb-3">Aktif İhaleler</h3>
        
        <div class="row">
    
    <% if (ihaleler.length === 0) { %>
        <div class="col-12">
            <div class="alert alert-warning">Şu an açık bir ihale yok.</div>
        </div>
    <% } %>

    <% ihaleler.forEach(ihale => { %>
        <div class="col-md-4 mb-4">
            <div class="card h-100 border-0 shadow-sm overflow-hidden">
                
                <div style="overflow: hidden; height: 200px;">
                    <% if (ihale.image_url) { %>
                        <img src="/static/images/<%= ihale.image_url %>" class="card-img-top" alt="Ürün Resmi" style="height: 100%; width: 100%; object-fit: cover;">
                    <% } else { %>
                        <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 100%;">
                            <span>Resim Yok</span>
                        </div>
                    <% } %>
                </div>

                <div class="card-body">
                    <h5 class="card-title text-primary"><%= ihale.title %></h5>
                    
                    <p class="card-text text-muted small"><%- ihale.description %></p>                    
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-bold text-secondary small">Güncel Fiyat:</span>
                        <span class="badge bg-success fs-5">
                            <%= ihale.en_yuksek_teklif ? ihale.en_yuksek_teklif : ihale.start_price %> ₺
                        </span>
                    </div>

                    <div class="alert alert-warning p-2 text-center mb-0">
                        <small class="text-muted d-block" style="font-size: 0.7rem;">KALAN SÜRE</small>
                        <span class="countdown-box text-danger" data-endtime="<%= ihale.end_date %>">
                            Hesaplanıyor...
                        </span>
                    </div>

                </div>

                <div class="card-footer bg-white border-top-0 pb-3">
                    <form action="/bid" method="post" class="d-flex gap-2">
                        <input type="hidden" name="tender_id" value="<%= ihale.tender_id %>">
                        
                        <input type="number" name="amount" class="form-control" placeholder="Teklif" required min="<%= ihale.start_price %>">
                        
                        <button type="submit" class="btn btn-primary">Ver</button>
                    </form>
                </div>

            </div>
        </div>
    <% }) %>
    
        </div>
    </div>

    <script>
        function updateTimers() {
            const timers = document.querySelectorAll('.countdown-box');
            
            timers.forEach(timer => {
                const endTimeStr = timer.getAttribute('data-endtime');
                const endTime = new Date(endTimeStr).getTime();
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    timer.innerHTML = "SÜRE DOLDU";
                    timer.classList.remove('text-danger');
                    timer.classList.add('text-secondary');
                    // Süre dolduysa teklif butonunu gizleyebiliriz (İsteğe bağlı)
                    const form = timer.closest('.card').querySelector('form');
                    if(form) form.style.display = 'none';
                } else {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    // Eğer 1 günden fazlaysa Gün göster, azsa saat:dk:sn göster
                    if (days > 0) {
                        timer.innerHTML = `${days} Gün ${hours} Saat`;
                    } else {
                        timer.innerHTML = `${hours}sa ${minutes}dk ${seconds}sn`;
                    }
                }
            });
        }

        // Sayfayı açar açmaz hesapla
        updateTimers();
        // Her 1 saniyede bir güncelle
        setInterval(updateTimers, 1000);
    </script>

</body>
</html>